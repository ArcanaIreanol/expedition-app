<dom-module id="quest-search">
  <style>
    :host ::content instruction {
      display: block;
      padding: var(--vw-small);
    };
    :host ::content comment {
      display: none;
    };

    #fileselect {
      position: fixed;
      top: -100em;
    }

    #questchooser a {
      display: inline-block;
      float: right;
    }

    #quest {
      display: inline-block;
      font-size: var(--font-size-interactive);
      padding: var(--vh-base) 0;
      font-family: var(--font-body);
      border: var(--border-size) solid var(--border-color-accent);
      line-height: 1.2em;
      margin-top: var(--vh-base);
    }

    .pad {
      padding-left: var(--vw-base);
      @apply(--layout-flex-3);
      @apply(--layout-vertical);
    }

    .centered {
      text-align: center;
    }
    .centered h3 {
      margin: 0;
    }
    .centered .author {
      font-size: var(--font-size-flavortext);
      margin-bottom: var(--vw-large);
    }


  </style>
  <template>
    <expedition-card-set id="pages" initial="intro">
      <expedition-card title="Public Quests" data-route="intro" icon="adventurer">
        <template is="dom-if" if="{{!loggedIn}}">
          <p>
            <strong>Online Play Disclaimer</strong>
          </p>
          <p>
            Public quests are published by other adventurers like yourselves. We offer no guarantees
            of completeness, correctness of grammar, or sensibility for any of the quests you are about to see.
          </p>
          <p>
            We use your basic Google account information to show quests you've specifically published.
          </p>
          <expedition-button on-tap="_onLogin">Continue with Google</expedition-button>
        </template>
        <template is="dom-if" if="{{loggedIn}}">
          <paper-dropdown-menu label="Visibility">
            <paper-menu class="dropdown-content" selected="{{visibility}}" selected="0">
              <paper-item>Your Quests</paper-item>
              <paper-item>All Quests</paper-item>
            </paper-menu>
          </paper-dropdown-menu>
          <expedition-input label="Search Text" type="text" value="{{searchText}}"></expedition-input>
          <expedition-input label="# Players" type="number" value="{{numPlayers}}" numeric></expedition-input>
          <expedition-button id="search" on-tap="_onSearch">Search</expedition-button>
        </template>
      </expedition-card>
      <expedition-card title="Search Results"  data-route="results" on-return="prev">
        <template is="dom-if" if="{{loading}}">
          <!--TODO Add Spinner-->
          Loading...
        </template>
        <template is="dom-repeat" items="{{quests}}">
          <expedition-item on-tap="_onQuestTap" data-target$="{{index}}">
            <h1>{{item.meta_title}}</h1>
            <div>{{item.meta_summary}}</div>
          </expedition-item>
        </template>
        <template is="dom-if" if="{{!quests.length}}">
          No quests found.
        </template>
      </expedition-card>
      <expedition-card title="Quest Details"  data-route="details" on-return="prev">
        <div class="centered">
          <h3>{{quest.title}}</h3>
          <div class="author">{{quest.author}}</div>
          <p>
            {{quest.summary}}
          </p>
        </div>
        <expedition-indicator icon="helper">
          <div>URL: <a href="{{quest.url}}" target="_blank">{{quest.shorturl}}</a></div>
          <div>Email: {{quest.email}}</div>
          <div>Players: {{quest.num_players}}</div>
          <div>Play time: {{quest.play_period}}</div>
          <div>Last update: {{quest.modified}}</div>
          <template is="dom-if" if="{{quest.user_owned}}">
            <div>{{quest.created}}</div>
            <div>{{quest.published}}</div>
          </template>
        </expedition-indicator>
        <expedition-button on-tap="_onQuestPlay" data-target$="{{quest}}">Play</expedition-button>
      </expedition-card>
    </expedition-card-set>
  </template>
  <script>
    /*global GlobalsBehaviour */
    /*global ExpeditionAPI */
    Polymer({
      is: 'quest-search',
      behaviors: [GlobalsBehaviour],
      ready: function() {
        this.loggedIn = ExpeditionAPI.isLoggedIn();
        this.quests=[];
        this.userOwnedQuest = false;
      },
      _onLogin: function() {
        ExpeditionAPI.login(function(locals) {
          this.loggedIn = ExpeditionAPI.isLoggedIn();
          console.log(locals);
          this.loading = true;
          ExpeditionAPI.searchQuests({owner: ExpeditionAPI.getLoggedInUser().id}, function(result) {
            if (result.error) {
              console.log(result.error);
            }
            this.loading = false;
            this.quests = result.quests;
          }.bind(this));
        }.bind(this));
      },
      _truncate: function(s, n) {
        return s.substr(0,n-1)+(s.length>n?'&hellip;':'');
      },
      _formatDate: function(rfcDateTime) {
        if (!rfcDateTime) {
          return "unknown";
        }
        return rfcDateTime.split('T')[0];
      },
      _formatPlayPeriod: function(minMinutes, maxMinutes) {
        if (minMinutes > 60 && maxMinutes > 60) {
          return Math.round(minMinutes / 60) + '-' + Math.round(maxMinutes / 60) + " hours";
        } else {
          return minMinutes + '-' + maxMinutes + " minutes";
        }
      },
      /* jshint ignore:start */
      _formattedQuest: function(quest) {
        return {
          id: quest.id,
          xml_url: quest.url,
          title: quest.meta_title,
          summary: quest.meta_summary,
          modified: this._formatDate(quest.modified),
          url: quest.meta_url,
          shorturl: this._truncate(quest.meta_url, 20),
          author: quest.meta_author,
          email: quest.meta_email,
          play_period: this._formatPlayPeriod(quest.meta_minTimeMinutes, quest.meta_maxTimeMinutes),
          num_players: quest.meta_minPlayers + '-' + quest.meta_maxPlayers,
          created: this._formatDate(quest.created),
          published: this._formatDate(quest.published),
          reported: false,
          user_owned: Boolean(quest.user === ExpeditionAPI.getLoggedInUser())
        };
      },
      /* jshint ignore:end */
      _onQuestTap: function(e) {
        var idx = e.currentTarget.dataset.target;
        this.quest = this._formattedQuest(this.quests[idx]);
        this.$.pages.next('details');
      },
      _onQuestPlay: function(e) {
        var quest = e.currentTarget.dataset.target;
        this.fire('quest-select', quest);
      },
      _onSearch: function() {
        var params = {};

        if (this.visibility === "Your Quests") {
          params.owner = ExpeditionAPI.getLoggedInUser().id;
        }
        if (this.numPlayers) {
          params.players = parseInt(this.numPlayers);
        }
        if (this.searchText) {
          params.search = this.searchText;
        }

        ExpeditionAPI.searchQuests(params, function(result) {
          if (result.error) {
            console.log(result.error);
          }
          this.loading = false;
          this.quests = result.quests;
        }.bind(this));
        this.$.pages.next('results');
      },
      prev: function(e) {
        // TODO: Dedupe this across various elements.
        var p = Polymer.dom(e.srcElement).previousSibling;
        while (p.tagName !== "EXPEDITION-CARD") {
          p = p.previousSibling;
        }
        this.$.pages.prev(p.dataset.route);
        e.stopPropagation();
      },
      properties: {
        quest: Object
      }
    });
  </script>
</dom-module>