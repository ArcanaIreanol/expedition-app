<dom-module id="quest-search">
  <style>
    :host ::content instruction {
      display: block;
      padding: var(--vw-small);
    };
    :host ::content comment {
      display: none;
    };

    #fileselect {
      position: fixed;
      top: -100em;
    }

    #questchooser a {
      display: inline-block;
      float: right;
    }

    #quest {
      display: inline-block;
      font-size: var(--font-size-interactive);
      padding: var(--vh-base) 0;
      font-family: var(--font-body);
      border: var(--border-size) solid var(--border-color-accent);
      line-height: 1.2em;
      margin-top: var(--vh-base);
    }
  </style>
  <template>
    <expedition-card title="Public Quests" data-route="intro" icon="adventurer">
      <template is="dom-if" if="{{!logged_in}}">
        <p>
          <strong>Online Play Disclaimer</strong>
        </p>
        <p>
          Public quests are published by other adventurers like yourselves. We offer no guarantees
          of completeness, correctness of grammar, or sensibility for any of the quests you are about to see.
        </p>
        <p>
          If you do encounter a faulty quest, please help the community and report it.
        </p>
        <p>
          We use your basic Google account information to show quests you've specifically published.
        </p>
        <expedition-button on-tap="_onLogin">Continue with Google</expedition-button>
      </template>
      <template is="dom-if" if="{{logged_in}}">
        <expedition-button on-tap="_onFilterTap">Filter Search</expedition-button>
        <hr/>
        <template is="dom-if" if="{{loading}}">
          <!--TODO Add Spinner-->
          Loading...
        </template>
        <template is="dom-repeat" id="encounterlist" items="{{quests}}">
          <expedition-item on-tap="_onQuestTap" data-target$="{{index}}">
            <h1>{{item.meta_title}}</h1>
            <div>{{item.meta_summary}}</div>
          </expedition-item>
        </template>
      </template>
    </expedition-card>
    <expedition-dialog title="{{quest.title}}" id="quest_details">
      <div><b>Summary:</b> {{quest.summary}}</div>
      <div><b>Last update:</b> {{quest.modified}}</div>
      <div><b>URL:</b> <a href="{{quest.url}}" target="_blank">{{quest.shorturl}}</a></div>
      <div><b>Author: </b> {{quest.author}}</div>
      <div><b>Email: </b> {{quest.email}}</div>
      <div><b>Play time:</b> {{quest.play_period}}</div>
      <div><b>Players:</b> {{quest.num_players}}</div>
      <template is="dom-if" if="{{quest.user_owned}}">
        <div>{{quest.created}}</div>
        <div>{{quest.published}}</div>
      </template>
      <expedition-button on-tap="_onQuestPlay" data-target$="{{quest}}">Play</expedition-button>
      <template is="dom-if" if="{{!quest.reported}}" restamp="true">
        <expedition-button on-tap="_onQuestReport" data-targets$="{{quest}}">Report</expedition-button>
      </template>
      <template is="dom-if" if="{{quest.reported}}" restamp="true">
        <expedition-button data-targets$="{{quest}}" class="disabled">
          Quest reported.
        </expedition-button>
      </template>
    </expedition-dialog>
    <expedition-dialog title="Filter Search" id="filter_search">
      <div>
        Visibility:
        <select id="visibility">
          <option value="self" selected>Your Quests</option>
          <option value="all">All Quests</option>
        </select>
      </div>
      <div>
        Search: <input type="text" id="search_text"/>
      </div>
      <div>
        # Players: <input type="number" id="num_players"/>
      </div>
      <expedition-button id="search" on-tap="_onSearch">Search</expedition-button>
    </expedition-dialog>
  </template>
  <script>
    /*global GlobalsBehaviour */
    /*global ExpeditionAPI */
    Polymer({
      is: 'quest-search',
      behaviors: [GlobalsBehaviour],
      ready: function() {
        this.logged_in = ExpeditionAPI.isLoggedIn();
        this.quests=[];
        this.user_owned_quest = false;
      },
      _onLogin: function() {
        ExpeditionAPI.login(function(locals) {
          this.logged_in = ExpeditionAPI.isLoggedIn();
          console.log(locals);
          this.loading = true;
          ExpeditionAPI.searchQuests({owner: ExpeditionAPI.getLoggedInUser().id}, function(result) {
            if (result.error) {
              console.log(result.error);
            }
            console.log(result.quests);
            this.loading = false;
            this.quests = result.quests;
          }.bind(this));
        }.bind(this));
      },
      _truncate(s, n) {
        return s.substr(0,n-1)+(s.length>n?'&hellip;':'');
      },
      _formatDate: function(rfc_datetime) {
        if (!rfc_datetime) {
          return "unknown";
        }
        return rfc_datetime.split('T')[0];
      },
      _formatPlayPeriod: function(min_minutes, max_minutes) {
        if (min_minutes > 60 && max_minutes > 60) {
          return Math.round(min_minutes / 60) + '-' + Math.round(max_minutes / 60) + " hours";
        } else {
          return min_minutes + '-' + max_minutes + " minutes";
        }
      },
      _formattedQuest: function(quest) {
        return {
          id: quest.id,
          xml_url: quest.url,
          title: quest.meta_title,
          summary: quest.meta_summary,
          modified: this._formatDate(quest.modified),
          url: quest.meta_url,
          shorturl: this._truncate(quest.meta_url, 20),
          author: quest.meta_author,
          email: quest.meta_email,
          play_period: this._formatPlayPeriod(quest.meta_minTimeMinutes, quest.meta_maxTimeMinutes),
          num_players: quest.meta_minPlayers + '-' + quest.meta_maxPlayers,
          created: this._formatDate(quest.created),
          published: this._formatDate(quest.published),
          reported: false,
          user_owned: Boolean(quest.user === ExpeditionAPI.getLoggedInUser())
        };
      },
      _onQuestTap: function(e) {
        var idx = e.currentTarget.dataset.target;
        this.quest = this._formattedQuest(this.quests[idx]);
        this.$.quest_details.open();
      },
      _onQuestPlay: function(e) {
        var quest = e.currentTarget.dataset.target;
        console.log(quest);
        this.$.quest_details.close();
        this.fire('quest-select', quest);
      },
      _onQuestReport: function(e) {
        console.log("Reported!");
        this.set('quest.reported', true);
      },
      _onSearchTextChange: function() {
        this.debounce('search', this._onSearch.bind(this), 300);
      },
      _onFilterTap: function() {
        this.$.filter_search.open();
      },
      _onSearch: function() {
        var params = {};

        var visibility = this.$.visibility.value;
        if (visibility === "self") {
          params.owner = ExpeditionAPI.getLoggedInUser().id;
        }

        var num_players = this.$.num_players.value;
        if (num_players) {
          params.players = parseInt(num_players);
        }

        var search_text = this.$.search_text.value;
        if (search_text) {
          params.search = search_text;
        }

        this.$.filter_search.close();
        ExpeditionAPI.searchQuests(params, function(result) {
          if (result.error) {
            console.log(result.error);
          }
          console.log(result.quests);
          this.loading = false;
          this.quests = result.quests;
        }.bind(this));
      },
      properties: {
        quest: Object
      }
    });
  </script>
</dom-module>