<dom-module id="quest-tester">
  <style>
    :host ::content instruction {
      display: block;
      padding: var(--vw-small);
    };
    :host ::content comment {
      display: none;
    };

    #fileselect {
      position: fixed;
      top: -100em;
    }

    #questchooser a {
      display: inline-block;
      float: right;
    }

    #quest {
      display: inline-block;
      font-size: var(--font-size-interactive);
      padding: var(--vh-base) 0;
      font-family: var(--font-body);
      border: var(--border-size) solid var(--border-color-accent);
      line-height: 1.2em;
      margin-top: var(--vh-base);
    }
  </style>
  <template>
    <expedition-card-set id="pages" initial="intro" title="Play Style">
      <expedition-card title="Custom Quest" data-route="intro" icon="adventurer">
        <p>
          Select a local file or provide a URL to begin a custom quest!
        </p>
        <label> <!-- Clicking anywhere inside the label opens the input -->
        <expedition-button>
          Select a local file
          <input id="fileselect" type="file" name="fileselect" on-change="_onFileSelected" />
        </expedition-button>
        </label>
        <expedition-button on-tap="_openQuestChooser">
          Load by ID
        </expedition-button>
        <expedition-button on-tap="_onLearnMore">
          Learn More
        </expedition-button>
      </expedition-card>
      <expedition-card title="Learn More" data-route="learnmore" icon="cards" on-return="_return">
        <p>
          Interested in creating your own custom quest? See the quest format spec and our example quest for details.
        </p>
        <p>
          When designing quests, we recommend using a desktop with Chrome and emulating a mobile device to catch
          error messages when the quest loads.
        </p>
        <p>
          Please remember that this is a beta feature - enhancements and bugfixes are on the way, and your feedback is greatly appreciated!
        </p>
        <expedition-button href="../quests/oust_albanus.txt">Example Quest</expedition-button>
        <expedition-button href="../quests/quest_spec.txt">Quest Format Spec</expedition-button>
        <expedition-button href="https://developers.google.com/web/tools/chrome-devtools/iterate/device-mode/?hl=en">Chrome Mobile Emulation</expedition-button>
      </expedition-card>
    </expedition-card-set>
    <expedition-dialog title="Enter Quest ID" id="questchooser" modal>
      <input id="quest" type="text" name="quest"/>
      <expedition-button on-tap="_onQuestButtonClick">Submit</expedition-button>
    </expedition-dialog>
  </template>
  <script>
    /*global GlobalsBehaviour */
    Polymer({
      is: 'quest-tester',
      behaviors: [GlobalsBehaviour],
      ready: function() {
        this.$.fileselect.value = "";
        this.$.quest.value = "";
        this.$.pages.ready();
      },
      _return: function(e) {
        this.$.pages.prev("intro");
        e.stopPropagation();
      },
      _openQuestChooser: function() {
        this.$.questchooser.open();
      },
      _onLearnMore: function() {
        this.$.pages.next('learnmore');
      },
      _onFileSelected: function() {
        var f = new FileReader();
        f.onloadend = function() {
          console.log(this.$.fileselect.files[0].name);
          this.fire('file', f.result);
        }.bind(this);
        f.readAsText(this.$.fileselect.files[0]);
      },
      _onQuestButtonClick: function() {
        this._setQuestURL("https://expedition-quest-ide.appspot.com/raw/" + this.querySelector("#quest").value);
      },
      _onURLButtonClick: function() {
        this._setQuestURL(this.querySelector("#url").value);
      },
      _setQuestURL: function(url) {
        if (url.indexOf("http://") !== 0 && url.indexOf("https://") !== 0) {
          url = "http://" + url;
        }
        // URL validation regex from http://stackoverflow.com/a/8317014
        if (/^(?:(?:(?:https?):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(url) === false) {
          //return console.log('URL invalid. Please enter a valid URL.');
        }
        this.fire('url', url);
        this.$.questchooser.close();
      }
    });
  </script>
</dom-module>